<!DOCTYPE html>
<html lang="en">

<head>
    <title data-i18n-key="title">LUCKY COIN</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="js/language.js"></script>
    <link rel="icon" type="image/x-icon" href="assets/favicon.gif">

    <link rel="preload" as="image" href="assets/animations/coin_flip/0.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/1.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/2.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/3.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/4.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/5.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/6.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/7.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/8.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/9.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/10.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/11.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/12.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/13.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/14.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/15.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/16.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/17.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/18.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/19.png">

    <link rel="preload" as="image" href="assets/animations/coin_flip2/0.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/1.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/2.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/3.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/4.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/5.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/6.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/7.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/8.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/9.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/10.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/11.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/12.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/13.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/14.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/15.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/16.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/17.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/18.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/19.png">
</head>

<body>
    <div style="position: fixed; left: 20vw; right: 20vw; top: 0; bottom: 6vw; z-index: 1;" onclick="flipCoin(picture)"></div>
    <div style="position: fixed; left: 20vw; right: 20vw; top: calc(100% - 6vw); bottom: 0; z-index: 1;" onclick="showMenu()"></div>
    <div class="hbox" style=" position: fixed; align-items: center; justify-content: center; right: 0; left: 0; top: 0; bottom: 0;">
        <img class="coinPicture" id="coinPicture">
        <!-- <img src="assets/animations/coin_flip/0.png" style="margin-top: 10vw; height: 100vw; image-rendering: pixelated;"> -->
    </div>
    <audio id="flipAudioPlayer" src="assets/audio/flip.mp3" autoplay></audio>
    <audio id="menuAudioPlayer" src="assets/audio/menu_open.mp3"></audio>

    <div id="statsMenu" class="statsMenu" style="z-index: 2; color: white;">
        <div class="hbox" style="gap: 1em; font-size: larger;">
            <label data-i18n-key="statsCountAllLabel"></label>
            <label id="statsCountAllLabel">0</label>
        </div>
        <div class="hbox" style="gap: 1em;">
            <label data-i18n-key="statsCountHeadsLabel"></label>
            <label id="statsCountHeadsLabel">0</label>
        </div>
        <div class="hbox" style="gap: 1em;">
            <label data-i18n-key="statsCountTailsLabel"></label>
            <label id="statsCountTailsLabel">0</label>
        </div>
    </div>
</body>

<script>
    const picture = document.getElementById("coinPicture");
    const flipAudioPlayer = document.getElementById("flipAudioPlayer");
    const menuAudioPlayer = document.getElementById("menuAudioPlayer");
    const statsMenu = document.getElementById("statsMenu");
    const animationsJson = loadAnimationsJson();

    const animationMsDelay = 78;
        
    var randValue = 0;
    var playingAnimation = false;

    var countHeads = 0;
    var countTails = 0;

    function flipCoin(pic) {
        if (playingAnimation) return;
        randValue = getRandomInclusive(0, 1);

        animationsJson.then(data => {
            if (data === null) console.log("no data");
            else if (data) {
                playingAnimation = true;

                let animationIndex = randValue;
                
                let framesData = [];

                flipAudioPlayer.play();
                addAllVisually();
                
                for (let i = 0; i < data[animationIndex].frames.length; i++) {
                    let frameIndex = i;
                    var frameData = {
                        frameImageName: data[animationIndex].frames[frameIndex][0],
                        x: data[animationIndex].frames[frameIndex][1],
                        y: data[animationIndex].frames[frameIndex][2],
                        scale: data[animationIndex].frames[frameIndex][3],
                        rotate: data[animationIndex].frames[frameIndex][4],
                        val5: data[animationIndex].frames[frameIndex][5],
                        opacity: data[animationIndex].frames[frameIndex][6],
                        isVisible: !(data[animationIndex].frames[frameIndex][7]),
                    };
                    framesData.push(frameData);
                }
                for (let i = 0; i < framesData.length; i++) {
                    let func = () => {
                        pic.src = `assets/animations/${data[animationIndex].animationName}/${framesData[i].frameImageName}.png`;
                        pic.style.position = "relative";
                        pic.style.left = framesData[i].x/10.0 + "vw";
                        pic.style.top = framesData[i].y/5.0 + "%";
                        pic.style.scale = (framesData[i].scale * 100.0/130.0) + "%";
                        pic.style.rotate = framesData[i].rotate + "deg";
                        pic.style.opacity = framesData[i].isVisible ? framesData[i].opacity / 255.0 : 0.0;

                        if (i >= 35) {
                            document.title = animationIndex == 0 ? translateString("heads") : translateString("tails");
                            if (i == 35) {
                                animationIndex == 0 ? addHeads() : addTails();
                            }
                        }
                        else {
                            document.title = ". ".repeat(Math.floor((i % 9) / 3) + 1);
                        }
                        
                        if (i == framesData.length - 1) {
                            playingAnimation = false;
                        }
                    };
                    if (i == 0) func();
                    else setTimeout(func, animationMsDelay * i);
                }
            }
        });
    }
    function loadAnimationsJson() {
        return fetch(`./assets/animations/animations.json`)
            .then(response => {
                if (!response.ok) {
                    return null;
                }
                return response.json();
            })
            .catch(error => {
                return null;
            });
    }
    function getRandomInclusive(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    
    const statsCountAllLabel = document.getElementById("statsCountAllLabel");
    const statsCountHeadsLabel = document.getElementById("statsCountHeadsLabel");
    const statsCountTailsLabel = document.getElementById("statsCountTailsLabel");
    
    const addAllVisually = () =>
    {
        statsCountAllLabel.textContent = countHeads + countTails + 1;
    };
    const addHeads = () =>
    {
        countHeads++;
        statsCountHeadsLabel.textContent = countHeads;
        statsCountAllLabel.textContent = countHeads + countTails;
    };
    const addTails = () =>
    {
        countTails++;
        statsCountTailsLabel.textContent = countTails;
        statsCountAllLabel.textContent = countHeads + countTails;
    };

    function showMenu() {
        if (!statsMenu.classList.contains("visible")) {
            statsMenu.classList.add("visible");
            menuAudioPlayer.src = "assets/audio/menu_open.mp3";
            menuAudioPlayer.play();
        }
        else {
            statsMenu.classList.remove("visible");
            menuAudioPlayer.src = "assets/audio/menu_close.mp3";
            menuAudioPlayer.play();
        }
    }
    
    function keyDownHandler(e) {
        var evtobj = window.event ? window.event : e;
        if (evtobj.keyCode == 90 || evtobj.keyCode == 32 || evtobj.keyCode == 13) { // z, space, enter
            flipCoin(picture);
        }
        if (evtobj.keyCode == 88) { // x
            showMenu();
        }
    }
    window.addEventListener('keydown', keyDownHandler);

    document.onload += flipCoin(picture);

</script>

</html>