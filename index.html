<!DOCTYPE html>
<html lang="en">

<head>
    <title data-i18n-key="title">LUCKY COIN</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="js/language.js"></script>
    <link rel="icon" type="image/x-icon" href="assets/favicon.gif">

    <link rel="preload" as="image" href="assets/animations/coin_flip/0.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/1.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/2.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/3.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/4.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/5.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/6.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/7.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/8.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/9.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/10.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/11.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/12.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/13.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/14.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/15.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/16.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/17.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/18.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip/19.png">

    <link rel="preload" as="image" href="assets/animations/coin_flip2/0.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/1.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/2.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/3.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/4.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/5.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/6.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/7.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/8.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/9.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/10.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/11.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/12.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/13.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/14.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/15.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/16.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/17.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/18.png">
    <link rel="preload" as="image" href="assets/animations/coin_flip2/19.png">
</head>

<body>
    <!-- <div style="position: fixed; left: 20vw; right: 20vw; top: 0; bottom: 6vw; z-index: 10;" onclick="flipCoin(picture)"></div> -->
    <div style="position: fixed; left: 20vw; right: 20vw; top: calc(100% - 6vw); bottom: 0; z-index: 10;" onclick="showMenu()"></div>
    <div class="coinContainer">

        <!-- <img class="coinPicture" data-auto-toss="false" data-animation-playing="false" data-audio-player-id="coinAudioPlayer1" onclick="flipCoin(this)">
            <audio id="coinAudioPlayer1" src="assets/audio/flip.mp3"></audio> -->
        
    </div>
    
    <audio id="menuAudioPlayer" src="assets/audio/menu_open.mp3"></audio>

    <div id="statsMenu" class="statsMenu" style="z-index: 2; color: white;">
        <div style="margin-left: 2em; margin-bottom: 2em;">
            <div class="hbox" style="gap: 1em; font-size: x-large;">
                <label data-i18n-key="statsCountAllLabel"></label>
                <label id="statsCountAllLabel">0</label>
            </div>
            <div class="hbox" style="gap: 1em;">
                <label data-i18n-key="statsCountHeadsLabel"></label>
                <label id="statsCountHeadsLabel">0</label>
            </div>
            <div class="hbox" style="gap: 1em;">
                <label data-i18n-key="statsCountTailsLabel"></label>
                <label id="statsCountTailsLabel">0</label>
            </div>
        </div>
        
        <div class="hbox statsMenuDecoration">
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine0"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine2"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine1"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine2"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine0"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine2"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine1"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine2"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine0"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine2"></div>
            <div class="statsMenuDecorationLine" data-i18n-key="statsMenuDecorationLine1"></div>
        </div>
    </div>
</body>

<script>
    const menuAudioPlayer = document.getElementById("menuAudioPlayer");
    const statsMenu = document.getElementById("statsMenu");
    const root = document.documentElement;
    const animationsJson = loadAnimationsJson();

    const animationMsDelay = 78;
    var speedMultiplier = 1.0;
    var playingOneSound = false;
        
    var randValue = 0;

    var countAll = 0;
    var countHeads = 0;
    var countTails = 0;

    function flipCoin(coinPic, playOneSound = false) {
        if (coinPic.dataset.animationPlaying == "true") return;

        animationsJson.then(data => {
            if (data === null) console.log("no data");
            else if (data) {
                coinPic.dataset.animationPlaying = true;

                var coinPicZIndex = coinPic.style.zIndex;
                coinPic.style.zIndex = "0";

                let animationIndex = getRandomInclusive(0, 1);
                
                let framesData = [];
                
                let flipAudioPlayer = document.getElementById(coinPic.dataset.audioPlayerId);
                if (flipAudioPlayer && !playingOneSound){
                    // if (playOneSound){
                    //     playingOneSound = true;
                    // }

                    flipAudioPlayer.pause();
                    flipAudioPlayer.currentTime = 0;
                    flipAudioPlayer.playbackRate = speedMultiplier;
                    flipAudioPlayer.play();
                }
                playingOneSound = playOneSound;
                addAllVisually();
                
                for (let i = 0; i < data[animationIndex].frames.length; i++) {
                    let frameIndex = i;
                    var frameData = {
                        frameImageName: data[animationIndex].frames[frameIndex][0],
                        x: data[animationIndex].frames[frameIndex][1],
                        y: data[animationIndex].frames[frameIndex][2],
                        scale: data[animationIndex].frames[frameIndex][3],
                        rotate: data[animationIndex].frames[frameIndex][4],
                        val5: data[animationIndex].frames[frameIndex][5],
                        opacity: data[animationIndex].frames[frameIndex][6],
                        isVisible: !(data[animationIndex].frames[frameIndex][7]),
                    };
                    framesData.push(frameData);
                }
                for (let i = 0; i < framesData.length; i++) {
                    let func = () => {
                        coinPic.src = `assets/animations/${data[animationIndex].animationName}/${framesData[i].frameImageName}.png`;
                        coinPic.style.left = framesData[i].x/10.0 + "vw";
                        coinPic.style.top = framesData[i].y/5.0 + "%";
                        coinPic.style.scale = (framesData[i].scale * 100.0/130.0) + "%";
                        coinPic.style.rotate = framesData[i].rotate + "deg";
                        coinPic.style.opacity = framesData[i].isVisible ? framesData[i].opacity / 255.0 : 0.0;

                        if (i >= 35) {
                            document.title = animationIndex == 0 ? translateString("heads") : translateString("tails");
                            if (i == 35) {
                                animationIndex == 0 ? addHeads() : addTails();
                            }
                        }
                        else {
                            document.title = ". ".repeat(Math.floor((i % 9) / 3) + 1);
                        }
                        
                        if (i >= framesData.length - 1) {
                            coinPic.dataset.animationPlaying = false;
                            coinPic.style.zIndex = coinPicZIndex;
                            playingOneSound = false;
                            if (coinPic.dataset.autoToss == "true"){
                                flipCoin(coinPic);
                            }
                        }
                    };
                    if (i == 0) func(null);
                    else if (coinPic.dataset.animationPlaying == "true") setTimeout(func, animationMsDelay/speedMultiplier * i);
                }
            }
        });
    }

    function setAutoToss(coinPic) {
        // i hate myself
        if (coinPic.dataset.autoToss == "true") {
            coinPic.dataset.autoToss == "false";
        }
        else {
            coinPic.dataset.autoToss == "true";
        }
    }

    function loadAnimationsJson() {
        return fetch(`./assets/animations/animations.json`)
            .then(response => {
                if (!response.ok) {
                    return null;
                }
                return response.json();
            })
            .catch(error => {
                return null;
            });
    }
    function getRandomInclusive(min, max) {
        min = Math.ceil(min);
        max = Math.floor(max);
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    function addCoin() {
        var container = document.getElementsByClassName("coinContainer")[0];

        let newAudioPlayerId = 1;
        let idString = `coinAudioPlayer${newAudioPlayerId}`;
        while (document.getElementById(idString) !== null){
            newAudioPlayerId += 1;
            idString = `coinAudioPlayer${newAudioPlayerId}`;
        }
        
        const imgElement = document.createElement("img");
        container.appendChild(imgElement);
        imgElement.outerHTML = `<img class="coinPicture" data-auto-toss="false" data-animation-playing="false" data-audio-player-id="coinAudioPlayer${newAudioPlayerId}" onclick="flipCoin(this)">`;
        
        // apparently after setting the outer html, the element kills itself and the imgelement stays old, so i need to get an updated version. html is so weird man
        const newImgElement = container.querySelector(`.coinPicture[data-audio-player-id="coinAudioPlayer${newAudioPlayerId}"]`);
        
        var audioElement = document.createElement("audio");
        container.appendChild(audioElement);
        audioElement.outerHTML = `<audio id="coinAudioPlayer${newAudioPlayerId}" src="assets/audio/flip.mp3"></audio>`;
        
        var maxInRow = 3;
        var coinCount = document.getElementsByClassName("coinPicture").length > maxInRow ? maxInRow : document.getElementsByClassName("coinPicture").length;
        root.style.setProperty('--coin-count', coinCount);

        flipCoin(newImgElement);
    }
    
    const statsCountAllLabel = document.getElementById("statsCountAllLabel");
    const statsCountHeadsLabel = document.getElementById("statsCountHeadsLabel");
    const statsCountTailsLabel = document.getElementById("statsCountTailsLabel");
    
    const addAllVisually = () =>
    {
        countAll++;
        statsCountAllLabel.textContent = countAll;
    };
    const addHeads = () =>
    {
        countHeads++;
        statsCountHeadsLabel.textContent = countHeads;
    };
    const addTails = () =>
    {
        countTails++;
        statsCountTailsLabel.textContent = countTails;
    };

    function showMenu() {
        if (!statsMenu.classList.contains("visible")) {
            statsMenu.classList.add("visible");
            menuAudioPlayer.src = "assets/audio/menu_open.mp3";
            menuAudioPlayer.play();
        }
        else {
            statsMenu.classList.remove("visible");
            menuAudioPlayer.src = "assets/audio/menu_close.mp3";
            menuAudioPlayer.play();
        }
    }
    
    function keyDownHandler(e) {
        var evtobj = window.event ? window.event : e;
        if (evtobj.keyCode == 90 || evtobj.keyCode == 32 || evtobj.keyCode == 13) { // z, space, enter
            flipAll();
        }
        else if (evtobj.keyCode == 61) { // + (=)
            addCoin();
        }
        else if (evtobj.keyCode == 88) { // x
            showMenu();
        }
    }
    window.addEventListener('keydown', keyDownHandler);

    function flipAll() {
        var list = document.getElementsByClassName("coinPicture");
        for (let element of list) flipCoin(element, true);
    }

    //document.onload += addCoin();
    window.addEventListener("DOMContentLoaded", addCoin);
    //document.onload += flipAll();

</script>

</html>